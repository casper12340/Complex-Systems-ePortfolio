---
title: "Module 7"
output: html_document
---
```{r}

```

```{r}
df <- read.csv('stock_details_5_years.csv')

df_googl <- df[df$Company == "GOOGL", ]
df_googl
```

```{r}
# Plot the 'Open' prices
plot(df_googl$Low, type = 'l', col = 'blue',
     xlab = "Time", ylab = "Price", main = "Low and High Prices")

# Add the 'Close' prices to the same plot
lines(df_googl$High, col = 'red')

# Optionally, add a legend
legend("topright", legend = c("Open", "Close"), col = c("blue", "red"), lty = 1)

```
```{r}
low <- df_googl$Low[!is.na(df_googl$Low)]
low.station <- (low - mean(low))/sd(low)
plot(low.station,type='l', xlab = "Time", ylab="Low Level")
```

```{r}
low.SampEn <- pracma::sample_entropy(low.station, edim=2,r=0.2*sd(low.station),tau=1)
print(low.SampEn)
```
```{r}
set.seed(38472)
# Create an example surrogate
# Create 100 randomized surrogates, okay it really took too long, so I switched it to 20 for this example

rand.surr.s1.joy.station.20 <- replicate(20, sample(low.station, replace=FALSE))

# Now run SampEn on all the surrogates
rand.surr.s1.joy.station.SampEn.20 <- apply(rand.surr.s1.joy.station.20, MARGIN=2, FUN = pracma::sample_entropy, edim=2,r=0.2*sd(rand.surr.s1.joy.station.20[,1]),tau=1)

# Calculate mean
mean <- mean(rand.surr.s1.joy.station.SampEn.20)

# Calculate length
n <- length(rand.surr.s1.joy.station.SampEn.20)

# Calculate standard deviation
sd <- sd(rand.surr.s1.joy.station.SampEn.20)

# Calculate Standard Error
error <- qt(.975 + (1 - .975)/2, df = n - 1) * sd/sqrt(n)

# CI
CI <- c(lower = mean - error, mean = mean, upper = mean + error)
print(CI)
```

```{r}
# These results show that there is an underlying pattern in the GooGl Low dataset that is gone when you randomly shuffle the data.
```

```{r}
# Histogram of surrogate SampEn values
hist(rand.surr.s1.joy.station.SampEn.20,
     main = "Surrogate SampEn Distribution",
     xlab = "Sample Entropy",
     col = "lightgray",
     border = "white")

# Add vertical line for original SampEn
#abline(v = low.SampEn, col = "red", lwd = 2)
#legend("topright", legend = c("Original SampEn"), col = c("red"), lwd = 2)


#The histogram shows that all surrogate SampEn values are much higher than your actual SampEn (0.125), providing strong evidence that your original time series contains real, non-random structure.
```
```{r}
# Calculate p-value: proportion of surrogate SampEn values less than or equal to the observed value
p_value <- mean(rand.surr.s1.joy.station.SampEn.20 <= low.SampEn)
print(paste("p-value =", p_value))



#P = 0 so this supports the hypothesis that the low signal is non-random, with structured, predictable dynamics. 
```
```{r}
# Checks if all stock signals are equally structured

# Repeat for another signal, say High prices
high <- df_googl$High[!is.na(df_googl$High)]
high.station <- (high - mean(high))/sd(high)
high.SampEn <- pracma::sample_entropy(high.station, edim=2,r=0.2*sd(high.station),tau=1)

print(high.SampEn)

# Repeat for another signal, say High prices
open <- df_googl$Open[!is.na(df_googl$Open)]
open.station <- (open - mean(open))/sd(open)
open.SampEn <- pracma::sample_entropy(open.station, edim=2,r=0.2*sd(open.station),tau=1)

print(open.SampEn)


#The values are below 1, which means that they are more regular, predicatble and potentially deterministic.
#If the value is higher between 1.5 and 3, it is more random-like and has less structure.
```

```{r}
# AAFT surrogates - nonlinearity vs linear stochastic processes.
library(nonlinearTseries)

# Generate 20 AAFT surrogates
aaft.surr <- t(FFTsurrogate(low.station, n.samples = 20))

# Calculate SampEn for AAFT surrogates
aaft.SampEn <- apply(aaft.surr, 2, function(x) pracma::sample_entropy(x, edim = 2, r = 0.2 * sd(x), tau = 1))

# Confidence Interval
aaft.mean <- mean(aaft.SampEn)
aaft.sd <- sd(aaft.SampEn)
aaft.n <- length(aaft.SampEn)
aaft.error <- qt(0.975, df = aaft.n - 1) * aaft.sd / sqrt(aaft.n)
aaft.CI <- c(lower = aaft.mean - aaft.error, mean = aaft.mean, upper = aaft.mean + aaft.error)
print(aaft.CI)

# Compare to original SampEn
print(low.SampEn)

aaft.p_value <- mean(aaft.SampEn <= low.SampEn)
print(paste("AAFT p-value =", aaft.p_value))

#The sample entropy doesn't fall within the 95% confidence interval so we have to reject the null hypothesis which states that the data is random. 
```
```{r}
hist(rand.surr.s1.joy.station.SampEn.20, 
     main = "SampEn: Random vs AAFT Surrogates",
     xlab = "Sample Entropy", col = rgb(0.1, 0.1, 0.8, 0.5), 
     border = "white", xlim = range(c(rand.surr.s1.joy.station.SampEn.20, aaft.SampEn)))

hist(aaft.SampEn, col = rgb(0.8, 0.1, 0.1, 0.5), add = TRUE)

abline(v = low.SampEn, col = "black", lwd = 2)
legend("topright", legend = c("Random", "AAFT", "Original"),
       fill = c(rgb(0.1,0.1,0.8,0.5), rgb(0.8,0.1,0.1,0.5), "black"))

```
```{r}
analyze_signal <- function(signal, name="") {
  signal <- signal[!is.na(signal)]
  station <- (signal - mean(signal)) / sd(signal)
  SampEn <- pracma::sample_entropy(station, edim=2, r=0.2*sd(station), tau=1)

  # Random surrogate
  rand.surr <- replicate(20, sample(station, replace=FALSE))
  rand.SampEn <- apply(rand.surr, 2, function(x) pracma::sample_entropy(x, edim=2, r=0.2*sd(x), tau=1))
  rand.CI <- quantile(rand.SampEn, probs = c(0.025, 0.5, 0.975))
  rand.p <- mean(rand.SampEn <= SampEn)

  # AAFT surrogate
  aaft.surr <- t(FFTsurrogate(station, n.samples = 20))
  aaft.SampEn <- apply(aaft.surr, 2, function(x) pracma::sample_entropy(x, edim=2, r=0.2*sd(x), tau=1))
  aaft.CI <- quantile(aaft.SampEn, probs = c(0.025, 0.5, 0.975))
  aaft.p <- mean(aaft.SampEn <= SampEn)

  cat("\n", "----", name, "----", "\n")
  cat("Observed SampEn:", SampEn, "\n")
  cat("Random CI:", rand.CI, "| p-value =", rand.p, "\n")
  cat("AAFT CI:", aaft.CI, "| p-value =", aaft.p, "\n")
}
analyze_signal(df_googl$Low, "Low")
analyze_signal(df_googl$High, "High")
analyze_signal(df_googl$Open, "Open")
analyze_signal(df_googl$Close, "Close")

```

